generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id                      String                   @id @default(cuid())
  email                   String                   @unique
  name                    String?
  role                    UserRole                 @default(RIDER)
  phone                   String?
  passwordHash            String
  photoUrl                String?
  bio                     String?
  ratingAverage           Float                    @default(0)
  ratingCount             Int                      @default(0)
  isVerifiedDriver        Boolean                  @default(false)
  memberSince             DateTime                 @default(now())
  accountStatus           AccountStatus            @default(ACTIVE)
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  emailVerified           Boolean                  @default(false)
  addressLine1            String?
  addressLine2            String?
  city                    String?
  country                 String?                  @default("US")
  onboardingCompleted     Boolean                  @default(false)
  postalCode              String?
  state                   String?
  stripeCustomerId        String?                  @unique
  stripeDefaultPaymentId  String?
  membershipActive        Boolean                  @default(false)
  membershipPlan          String?
  trialEndsAt             DateTime?
  publicId                String?                  @unique
  onboardingStep          Int?
  isAdmin                 Boolean                  @default(false)
  bookings                Booking[]                @relation("RiderBookings")
  driverConversations     Conversation[]           @relation("DriverConversations")
  riderConversations      Conversation[]           @relation("RiderConversations")
  driverProfile           DriverProfile?
  emailVerificationTokens EmailVerificationToken[]
  memberships             Membership[]
  messages                Message[]                @relation("UserMessages")
  passwordResetTokens     PasswordResetToken[]
  paymentMethods          PaymentMethod[]
  payouts                 Payout[]
  rides                   Ride[]                   @relation("DriverRides")
  riderRides              Ride[]                   @relation("RiderRides")
  ridePayments            RidePayment[]
  transactions            Transaction[]            @relation("DriverTransactions")
  adminGrantEndsAt        DateTime?

}

model DriverProfile {
  id                    String                   @id @default(cuid())
  userId                String                   @unique
  baseCity              String?
  baseLat               Float?
  baseLng               Float?
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt
  driverLicenseExpiry   DateTime?
  driverLicenseImageUrl String?
  driverLicenseNumber   String?
  driverLicenseState    String?
  verificationNotes     String?
  verificationStatus    DriverVerificationStatus @default(PENDING)
  dateOfBirth           DateTime?
  legalName             String?
  plateNumber           String?
  plateState            String?
  vehicleColor          String?
  vehicleMake           String?
  vehicleModel          String?
  vehicleYear           Int?
  user                  User                     @relation(fields: [userId], references: [id])
  serviceCities         DriverServiceCity[]
}

model DriverServiceCity {
  id              String        @id @default(cuid())
  driverProfileId String
  cityName        String
  cityLat         Float
  cityLng         Float
  createdAt       DateTime      @default(now())
  driverProfile   DriverProfile @relation(fields: [driverProfileId], references: [id])

  @@unique([driverProfileId, cityName])
  @@index([driverProfileId])
}

model Membership {
  id              String           @id @default(cuid())
  userId          String
  type            MembershipType
  startDate       DateTime
  expiryDate      DateTime
  status          MembershipStatus @default(ACTIVE)
  amountPaidCents Int
  paymentProvider String?
  paymentRef      String?
  createdAt       DateTime         @default(now())
  plan            MembershipPlan   @default(STANDARD)
  updatedAt       DateTime         @updatedAt
  user            User             @relation(fields: [userId], references: [id])

  @@index([userId, type, startDate])
  @@index([userId, type, expiryDate])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Ride {
  id              String         @id @default(cuid())
  driverId        String?
  originCity      String
  originLat       Float
  originLng       Float
  destinationCity String
  destinationLat  Float
  destinationLng  Float
  departureTime   DateTime
  distanceMiles   Float
  vehicleMake     String?
  vehicleModel    String?
  vehicleColor    String?
  licensePlate    String?
  preferencesJson Json?
  status          RideStatus     @default(OPEN)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  riderId         String?
  passengerCount  Int            @default(1)
  totalPriceCents Int            @default(0)
  tripCompletedAt DateTime?
  tripStartedAt   DateTime?
  clientRequestId String?        @unique
  bookings        Booking[]
  conversations   Conversation[]
  driver          User?          @relation("DriverRides", fields: [driverId], references: [id])
  rider           User?          @relation("RiderRides", fields: [riderId], references: [id])
  ridePayments    RidePayment[]
  transactions    Transaction[]

  @@index([driverId, status])
  @@index([riderId, status])
  @@index([departureTime])
}

model Booking {
  id               String         @id @default(cuid())
  rideId           String
  status           BookingStatus  @default(PENDING)
  createdAt        DateTime       @default(now())
  riderEmail       String?
  riderName        String?
  updatedAt        DateTime       @updatedAt
  riderId          String?
  cashDiscountBps  Int            @default(1000)
  paymentMethodId  String?
  paymentType      PaymentType    @default(CARD)
  baseAmountCents  Int            @default(0)
  currency         String         @default("usd")
  discountCents    Int            @default(0)
  finalAmountCents Int            @default(0)
  paymentMethod    PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  ride             Ride           @relation(fields: [rideId], references: [id])
  rider            User?          @relation("RiderBookings", fields: [riderId], references: [id])
  conversation     Conversation?
  ridePayments     RidePayment[]  @relation("BookingRidePayments")

  @@index([rideId])
  @@index([riderId])
  @@index([status])
  @@index([paymentType])
  @@index([paymentMethodId])
}

model Conversation {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  rideId    String
  driverId  String
  riderId   String
  bookingId String?   @unique
  booking   Booking?  @relation(fields: [bookingId], references: [id])
  driver    User      @relation("DriverConversations", fields: [driverId], references: [id])
  ride      Ride      @relation(fields: [rideId], references: [id])
  rider     User      @relation("RiderConversations", fields: [riderId], references: [id])
  messages  Message[]

  // NEW: per-user "read cursor"
driverLastReadAt DateTime?
riderLastReadAt  DateTime?


  @@index([rideId])
  @@index([driverId])
  @@index([riderId])
}


model Message {
  id             String       @id @default(cuid())
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  conversationId String
  senderId       String
  body           String
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  sender         User         @relation("UserMessages", fields: [senderId], references: [id])

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

model Transaction {
  id               String            @id @default(cuid())
  rideId           String
  driverId         String
  grossAmountCents Int
  serviceFeeCents  Int
  netAmountCents   Int
  status           TransactionStatus @default(PENDING)
  createdAt        DateTime          @default(now())
  driver           User              @relation("DriverTransactions", fields: [driverId], references: [id])
  ride             Ride              @relation(fields: [rideId], references: [id])

  @@index([driverId])
  @@index([rideId])
  @@index([status])
}

model PasswordResetToken {
  token     String   @id
  userId    String
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model PaymentMethod {
  id                      String        @id @default(cuid())
  userId                  String
  provider                String        @default("STRIPE")
  providerPaymentMethodId String?       @unique
  brand                   String?
  last4                   String?
  expMonth                Int?
  expYear                 Int?
  isDefault               Boolean       @default(false)
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  bookings                Booking[]
  user                    User          @relation(fields: [userId], references: [id])
  ridePayments            RidePayment[] @relation("RidePaymentPaymentMethod")

  @@index([userId])
  @@index([userId, isDefault])
}

model RidePayment {
  id                    String            @id @default(cuid())
  rideId                String
  riderId               String
  amountCents           Int
  currency              String            @default("usd")
  status                RidePaymentStatus @default(PENDING)
  provider              String            @default("STRIPE")
  providerRef           String?           @unique
  paymentMethodId       String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  authorizedAt          DateTime?
  baseAmountCents       Int               @default(0)
  canceledAt            DateTime?
  capturedAt            DateTime?
  discountCents         Int               @default(0)
  failedAt              DateTime?
  finalAmountCents      Int               @default(0)
  idempotencyKey        String?           @unique
  paymentType           PaymentType       @default(CARD)
  stripeChargeId        String?           @unique
  stripeCustomerId      String?
  stripePaymentIntentId String?           @unique
  bookingId             String?
  refunds               Refund[]
  booking               Booking?          @relation("BookingRidePayments", fields: [bookingId], references: [id])
  paymentMethod         PaymentMethod?    @relation("RidePaymentPaymentMethod", fields: [paymentMethodId], references: [id])
  ride                  Ride              @relation(fields: [rideId], references: [id], onDelete: Cascade)
  rider                 User              @relation(fields: [riderId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([riderId])
  @@index([rideId])
  @@index([paymentMethodId])
  @@index([paymentType])
  @@index([status])
  @@index([stripePaymentIntentId])
}

model Refund {
  id            String       @id @default(cuid())
  ridePaymentId String
  amountCents   Int
  currency      String       @default("USD")
  status        RefundStatus @default(PENDING)
  provider      String       @default("STRIPE")
  providerRef   String?      @unique
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  ridePayment   RidePayment  @relation(fields: [ridePaymentId], references: [id])

  @@index([ridePaymentId])
}

model Payout {
  id          String       @id @default(cuid())
  driverId    String
  amountCents Int
  currency    String       @default("USD")
  status      PayoutStatus @default(PENDING)
  provider    String       @default("STRIPE")
  providerRef String?      @unique
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  driver      User         @relation(fields: [driverId], references: [id])

  @@index([driverId])
}

enum UserRole {
  RIDER
  DRIVER
  ADMIN
}

enum AccountStatus {
  ACTIVE
  DISABLED
  SUSPENDED
}

enum MembershipType {
  RIDER
  DRIVER
}

enum MembershipStatus {
  ACTIVE
  EXPIRED
}

enum MembershipPlan {
  STANDARD
}

enum RideStatus {
  OPEN
  ACCEPTED
  IN_ROUTE
  COMPLETED
  CANCELLED
}

enum BookingStatus {
  PENDING
  ACCEPTED
  DECLINED
  CANCELLED
  COMPLETED
}

enum TransactionStatus {
  PENDING
  COMPLETED
  REFUNDED
}

enum DriverVerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RidePaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum RefundStatus {
  PENDING
  SUCCEEDED
  FAILED
}

enum PayoutStatus {
  PENDING
  PAID
  FAILED
}

enum PaymentType {
  CARD
  CASH
}
